function renderFrameworkQuestions(f){const c=document.getElementById('framework-questions');c.innerHTML='';if(f==='Naranjo'){const qs=[
"Are there previous conclusive reports on this reaction?","Did the adverse event appear after the suspected drug was administered?","Did the adverse reaction improve when the drug was discontinued or a specific antagonist was administered?","Did the adverse reaction reappear when the drug was re-administered?","Are there alternative causes that could have caused the reaction?","Did the reaction reappear with a placebo?","Was the drug detected in the blood (or other fluids) in concentrations known to be toxic?","Was the reaction more severe when the dose was increased or less severe when the dose was decreased?","Did the patient have a similar reaction to the same or similar drugs in any previous exposure?","Was the adverse event confirmed by any objective evidence?"
];const opts=[{label:'Yes',value:'yes'},{label:'No',value:'no'},{label:'Do not know',value:'dk'}];qs.forEach((q,i)=>{const d=document.createElement('div');d.className='question';d.innerHTML=`<label><strong>Q${i+1}.</strong> ${q}</label>`;const s=document.createElement('select');s.name=`naranjo_q${i+1}`;opts.forEach(o=>{const op=document.createElement('option');op.value=o.value;op.textContent=o.label;s.appendChild(op);});d.appendChild(s);c.appendChild(d);});}
else{const qs=["Time relationship between drug intake and event","Response to withdrawal (dechallenge)","Response to re-exposure (rechallenge)","Alternative explanations (disease/other drugs)","Objective evidence (labs, ECG, imaging)","Pharmacology/known ADR (label/literature)"];const opts=[{label:'Yes/Consistent',value:'yes'},{label:'No/Inconsistent',value:'no'},{label:'Unknown/Not available',value:'unknown'}];qs.forEach((q,i)=>{const d=document.createElement('div');d.className='question';d.innerHTML=`<label><strong>Factor ${i+1}.</strong> ${q}</label>`;const s=document.createElement('select');s.name=`who_factor_${i+1}`;opts.forEach(o=>{const op=document.createElement('option');op.value=o.value;op.textContent=o.label;s.appendChild(op);});d.appendChild(s);c.appendChild(d);});}} 
function naranjoScore(r){const pts={1:{yes:1,no:0,dk:0},2:{yes:2,no:-1,dk:0},3:{yes:1,no:0,dk:0},4:{yes:2,no:-1,dk:0},5:{yes:-1,no:2,dk:0},6:{yes:-1,no:1,dk:0},7:{yes:1,no:0,dk:0},8:{yes:1,no:0,dk:0},9:{yes:1,no:0,dk:0},10:{yes:1,no:0,dk:0}};let s=0;for(let i=1;i<=10;i++){const v=r[`naranjo_q${i}`];if(v&&pts[i][v]!==undefined)s+=pts[i][v];}return s;}
function naranjoClass(sc){if(sc>=9)return 'Definite'; if(sc>=5)return 'Probable'; if(sc>=1)return 'Possible'; if(sc<=0)return 'Unrelated'; return 'Possible';}
document.addEventListener('DOMContentLoaded',()=>{const f=document.getElementById('adj-form');const fw=document.getElementById('framework');renderFrameworkQuestions(fw.value);fw.addEventListener('change',()=>renderFrameworkQuestions(fw.value));
document.getElementById('calc-score').addEventListener('click',()=>{const fd=new FormData(f);const data=Object.fromEntries(fd.entries());let auto=null,cls=null;
if(data.framework==='Naranjo'){const resp={};for(let i=1;i<=10;i++)resp[`naranjo_q${i}`]=fd.get(`naranjo_q${i}`);auto=naranjoScore(resp);cls=naranjoClass(auto);}else{auto=null;cls='—';}
document.getElementById('auto-score').textContent=`Auto: ${cls}${auto!==null?' (score '+auto+')':''}`; if(cls&&cls!=='—') document.getElementById('causality').value=cls;});
f.addEventListener('submit',async e=>{e.preventDefault();const fd=new FormData(f);const data=Object.fromEntries(fd.entries());const payload={case_event_id:parseInt(data.case_event_id,10),framework:data.framework,responses:{},auto_score:null,causality:data.causality,severity:data.severity,expectedness:data.expectedness,index_attribution:data.index_attribution,suspected_concomitants:fd.getAll('suspected_concomitants[]'),rationale:data.rationale,missing_info:fd.getAll('missing_info[]')}; if(data.framework==='Naranjo'){for(let i=1;i<=10;i++) payload.responses[`naranjo_q${i}`]=fd.get(`naranjo_q${i}`); payload.auto_score=naranjoScore(payload.responses);} else {for(let i=1;i<=6;i++) payload.responses[`who_factor_${i}`]=fd.get(`who_factor_${i}`);} const ok=await api.submitAdjudication(payload); if(ok){ alert('Adjudication submitted.'); history.back(); }});});
